#!/bin/bash

main() {
	#Change into the real directory where the terramod script is located
	pushd $(dirname $(readlink `which terramod`)) >/dev/null

	# create package.json file for terramod - for ease of defining dependencies
	if [ ! -f package.json ]
	then
		create_package
	fi

	# create package-lock.json file for terramod - to ensure versions of node.js modules used at last runtime are locked
	if [ ! -f package-lock.json ]
	then
		create_package_lock
  fi

	# Determine if node is installed
	NODE_VERSION=$(node --version 2>&1)
	if [ $? -ne 0 ]
	then
		echo "Nodejs not found. Please install before running."
		echo "See https://nodejs.org/en/download/package-manager/ for instructions."
		exit 1
	fi

	# Determine if we have any unmet dependencies - if so, install those dependencies
	CHEERIO=$(npm list --depth 0 2>/dev/null | grep "UNMET DEPENDENCY" | wc -l)
	if [ $CHEERIO -gt 0 ]
	then
		echo "Missing dependencies. Installing with npm install"
		npm install
	fi

	# Grab args from user
	if [ -z "$1" ]
	then
		echo -e "Must supply terraform module to create. i.e. \033[93mterramod aws_instance\033[0m"
		exit 1
	fi

	NEW_MODULE=$1

	if [ -z "$2" ]
	then
		EXAMPLE_SCRIPT=1
	else
		EXAMPLE_SCRIPT=$2
	fi

	echo -e "Creating \033[1m${NEW_MODULE}\033[0m module using example \033[1m#${EXAMPLE_SCRIPT}\033[0m."

	# Pull page from terraform docs
	export TERRAMOD_PAGE_HTML=$(curl https://www.terraform.io/docs/providers/aws/r/${NEW_MODULE}.html 2>&1)

	# Run nodejs script and pass page html
	MODULE_SCRIPT=$(node terramod.js ${EXAMPLE_SCRIPT} 2>&1)

	# Change back to our runtime location
	popd > /dev/null

	# Create module dir if needed
	mkdir -p modules/${NEW_MODULE}
	touch modules/${NEW_MODULE}/main.tf
	touch modules/${NEW_MODULE}/variables.tf
	touch modules/${NEW_MODULE}/outputs.tf

	echo "$MODULE_SCRIPT" > modules/${NEW_MODULE}/main.tf

	echo -e "Created \033[93mmodules/${NEW_MODULE}/\033[0m and populated \033[93mmain.tf\033[0m with code from example \033[93m#${EXAMPLE_SCRIPT}\033[0m."

	exit 0
}

create_package_lock() {
	cat > package-lock.json <<- "EOF"
	{
	  "requires": true,
	  "lockfileVersion": 1,
	  "dependencies": {
	    "@types/node": {
	      "version": "6.0.87",
	      "resolved": "https://registry.npmjs.org/@types/node/-/node-6.0.87.tgz",
	      "integrity": "sha512-Xo0pYENOBaGtJUhi50KH6gdBNQmZQQxAwBArsJpBd15ncoz+LZD5Ev14vuezcw62CsQ1q6bM++7jA6jfwaAbfQ=="
	    },
	    "boolbase": {
	      "version": "1.0.0",
	      "resolved": "https://registry.npmjs.org/boolbase/-/boolbase-1.0.0.tgz",
	      "integrity": "sha1-aN/1++YMUes3cl6p4+0xDcwed24="
	    },
	    "cheerio": {
	      "version": "1.0.0-rc.2",
	      "resolved": "https://registry.npmjs.org/cheerio/-/cheerio-1.0.0-rc.2.tgz",
	      "integrity": "sha1-S59TqBsn5NXawxwP/Qz6A8xoMNs=",
	      "requires": {
	        "css-select": "1.2.0",
	        "dom-serializer": "0.1.0",
	        "entities": "1.1.1",
	        "htmlparser2": "3.9.2",
	        "lodash": "4.17.4",
	        "parse5": "3.0.2"
	      }
	    },
	    "core-util-is": {
	      "version": "1.0.2",
	      "resolved": "https://registry.npmjs.org/core-util-is/-/core-util-is-1.0.2.tgz",
	      "integrity": "sha1-tf1UIgqivFq1eqtxQMlAdUUDwac="
	    },
	    "css-select": {
	      "version": "1.2.0",
	      "resolved": "https://registry.npmjs.org/css-select/-/css-select-1.2.0.tgz",
	      "integrity": "sha1-KzoRBTnFNV8c2NMUYj6HCxIeyFg=",
	      "requires": {
	        "boolbase": "1.0.0",
	        "css-what": "2.1.0",
	        "domutils": "1.5.1",
	        "nth-check": "1.0.1"
	      }
	    },
	    "css-what": {
	      "version": "2.1.0",
	      "resolved": "https://registry.npmjs.org/css-what/-/css-what-2.1.0.tgz",
	      "integrity": "sha1-lGfQMsOM+u+58teVASUwYvh/ob0="
	    },
	    "dom-serializer": {
	      "version": "0.1.0",
	      "resolved": "https://registry.npmjs.org/dom-serializer/-/dom-serializer-0.1.0.tgz",
	      "integrity": "sha1-BzxpdUbOB4DOI75KKOKT5AvDDII=",
	      "requires": {
	        "domelementtype": "1.1.3",
	        "entities": "1.1.1"
	      },
	      "dependencies": {
	        "domelementtype": {
	          "version": "1.1.3",
	          "resolved": "https://registry.npmjs.org/domelementtype/-/domelementtype-1.1.3.tgz",
	          "integrity": "sha1-vSh3PiZCiBrsUVRJJCmcXNgiGFs="
	        }
	      }
	    },
	    "domelementtype": {
	      "version": "1.3.0",
	      "resolved": "https://registry.npmjs.org/domelementtype/-/domelementtype-1.3.0.tgz",
	      "integrity": "sha1-sXrtguirWeUt2cGbF1bg/BhyBMI="
	    },
	    "domhandler": {
	      "version": "2.4.1",
	      "resolved": "https://registry.npmjs.org/domhandler/-/domhandler-2.4.1.tgz",
	      "integrity": "sha1-iS5HAAqZvlW783dP/qBWHYh5wlk=",
	      "requires": {
	        "domelementtype": "1.3.0"
	      }
	    },
	    "domutils": {
	      "version": "1.5.1",
	      "resolved": "https://registry.npmjs.org/domutils/-/domutils-1.5.1.tgz",
	      "integrity": "sha1-3NhIiib1Y9YQeeSMn3t+Mjc2gs8=",
	      "requires": {
	        "dom-serializer": "0.1.0",
	        "domelementtype": "1.3.0"
	      }
	    },
	    "entities": {
	      "version": "1.1.1",
	      "resolved": "https://registry.npmjs.org/entities/-/entities-1.1.1.tgz",
	      "integrity": "sha1-blwtClYhtdra7O+AuQ7ftc13cvA="
	    },
	    "htmlparser2": {
	      "version": "3.9.2",
	      "resolved": "https://registry.npmjs.org/htmlparser2/-/htmlparser2-3.9.2.tgz",
	      "integrity": "sha1-G9+HrMoPP55T+k/M6w9LTLsAszg=",
	      "requires": {
	        "domelementtype": "1.3.0",
	        "domhandler": "2.4.1",
	        "domutils": "1.5.1",
	        "entities": "1.1.1",
	        "inherits": "2.0.3",
	        "readable-stream": "2.3.3"
	      }
	    },
	    "inherits": {
	      "version": "2.0.3",
	      "resolved": "https://registry.npmjs.org/inherits/-/inherits-2.0.3.tgz",
	      "integrity": "sha1-Yzwsg+PaQqUC9SRmAiSA9CCCYd4="
	    },
	    "isarray": {
	      "version": "1.0.0",
	      "resolved": "https://registry.npmjs.org/isarray/-/isarray-1.0.0.tgz",
	      "integrity": "sha1-u5NdSFgsuhaMBoNJV6VKPgcSTxE="
	    },
	    "lodash": {
	      "version": "4.17.4",
	      "resolved": "https://registry.npmjs.org/lodash/-/lodash-4.17.4.tgz",
	      "integrity": "sha1-eCA6TRwyiuHYbcpkYONptX9AVa4="
	    },
	    "nth-check": {
	      "version": "1.0.1",
	      "resolved": "https://registry.npmjs.org/nth-check/-/nth-check-1.0.1.tgz",
	      "integrity": "sha1-mSms32KPwsQQmN6rgqxYDPFJquQ=",
	      "requires": {
	        "boolbase": "1.0.0"
	      }
	    },
	    "parse5": {
	      "version": "3.0.2",
	      "resolved": "https://registry.npmjs.org/parse5/-/parse5-3.0.2.tgz",
	      "integrity": "sha1-Be/1fw70V3+xRKefi5qWemzERRA=",
	      "requires": {
	        "@types/node": "6.0.87"
	      }
	    },
	    "process-nextick-args": {
	      "version": "1.0.7",
	      "resolved": "https://registry.npmjs.org/process-nextick-args/-/process-nextick-args-1.0.7.tgz",
	      "integrity": "sha1-FQ4gt1ZZCtP5EJPyWk8q2L/zC6M="
	    },
	    "readable-stream": {
	      "version": "2.3.3",
	      "resolved": "https://registry.npmjs.org/readable-stream/-/readable-stream-2.3.3.tgz",
	      "integrity": "sha512-m+qzzcn7KUxEmd1gMbchF+Y2eIUbieUaxkWtptyHywrX0rE8QEYqPC07Vuy4Wm32/xE16NcdBctb8S0Xe/5IeQ==",
	      "requires": {
	        "core-util-is": "1.0.2",
	        "inherits": "2.0.3",
	        "isarray": "1.0.0",
	        "process-nextick-args": "1.0.7",
	        "safe-buffer": "5.1.1",
	        "string_decoder": "1.0.3",
	        "util-deprecate": "1.0.2"
	      }
	    },
	    "safe-buffer": {
	      "version": "5.1.1",
	      "resolved": "https://registry.npmjs.org/safe-buffer/-/safe-buffer-5.1.1.tgz",
	      "integrity": "sha512-kKvNJn6Mm93gAczWVJg7wH+wGYWNrDHdWvpUmHyEsgCtIwwo3bqPtV4tR5tuPaUhTOo/kvhVwd8XwwOllGYkbg=="
	    },
	    "string_decoder": {
	      "version": "1.0.3",
	      "resolved": "https://registry.npmjs.org/string_decoder/-/string_decoder-1.0.3.tgz",
	      "integrity": "sha512-4AH6Z5fzNNBcH+6XDMfA/BTt87skxqJlO0lAh3Dker5zThcAxG6mKz+iGu308UKoPPQ8Dcqx/4JhujzltRa+hQ==",
	      "requires": {
	        "safe-buffer": "5.1.1"
	      }
	    },
	    "util-deprecate": {
	      "version": "1.0.2",
	      "resolved": "https://registry.npmjs.org/util-deprecate/-/util-deprecate-1.0.2.tgz",
	      "integrity": "sha1-RQ1Nyfpw3nMnYvvS1KKJgUGaDM8="
	    }
	  }
	}
EOF
}

create_package() {
	cat > package.json <<- "EOF"
	{
	  "name": "terramod",
	  "version": "1.0.0",
	  "description": "Generate skeleton terraform module from example in terraform.io docs",
	  "main": "terramod.js",
	  "dependencies": {
	    "cheerio": "^1.0.0-rc.2"
	  },
	  "devDependencies": {},
	  "scripts": {
	    "test": "echo \"Error: no test specified\" && exit 1"
	  },
	  "repository": {
	    "type": "git",
	    "url": "git+https://github.com/thepastelsuit/terramod.git"
	  },
	  "author": "thepastelsuit",
	  "license": "ISC",
	  "bugs": {
	    "url": "https://github.com/thepastelsuit/terramod/issues"
	  },
	  "homepage": "https://github.com/thepastelsuit/terramod#readme"
	}
EOF
}

main "$@"
